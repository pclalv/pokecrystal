#!/usr/bin/env ruby

require 'json'
# require 'pry-byebug'

VERSION = "crystal-speedchoice"

BLACKLISTED_LABELS = %w(
  SurfFunction.ckir_BEFORE_CHECK_FOGBADGE
  TryCutOW.ckir_BEFORE_CHECK_HIVEBADGE
  FlyFunction.ckir_BEFORE_CHECK_STORMBADGE
)

# non-diffs that should be included anyway. these are 'patches'; a
# patch does not necessarily have a diff, but the randomizer can
# generate a diff patch from it.
PATCHES = %w(
  CeruleanGymHiddenMachinePart.ckir_BEFORE_dwb_EVENT_FOUND_MACHINE_PART_IN_CERULEAN_GYM_MACHINE_PART
  UnknownScript_0x1a009c.ckir_BEFORE_verbosegiveitem_HM_FLY
  CianwoodPharmacist.ckir_BEFORE_giveitem_SECRETPOTION
  Copycat.ckir_BEFORE_verbosegiveitem_PASS
  UnknownScript_0x99505.ckir_BEFORE_verbosegiveitem_HM_SURF
  CooltrainerMScript_0x9a5fb.ckir_BEFORE_verbosegiveitem_ITEMFINDER
  ElmGiveTicketScript.ckir_BEFORE_verbosegiveitem_S_S_TICKET
  ClerkScript_0x54750.ckir_BEFORE_giveitem_BICYCLE
  FlowerShopTeacherScript.ckir_BEFORE_verbosegiveitem_SQUIRTBOTTLE
  IcePath1FHMWaterfall.ckir_BEFORE_itemball_HM_WATERFALL
  IlexForestCharcoalMasterScript.ckir_BEFORE_verbosegiveitem_HM_CUT
  UnknownScript_0x7007a.ckir_BEFORE_giveitem_RED_SCALE
  MrPokemonsHouse_MapScriptHeader.ckir_BEFORE_giveitem_MYSTERY_EGG
  SailorScript_0x9c8c1.ckir_BEFORE_verbosegiveitem_HM_STRENGTH
  GoodRodGuru.ckir_BEFORE_verbosegiveitem_GOOD_ROD
  GrampsScript_0x18c00f.ckir_BEFORE_verbosegiveitem_SILVER_WING
  UnknownScript_0x191844.ckir_BEFORE_giveitem_LOST_ITEM
  UnknownScript_0x5d800.ckir_BEFORE_verbosegiveitem_BLUE_CARD
  FakeDirectorScript.ckir_BEFORE_verbosegiveitem_BASEMENT_KEY
  RadioTower5FRocketBossTrigger.ckir_BEFORE_verbosegiveitem_CLEAR_BELL
  FishingGuruScript_0x7f484.ckir_BEFORE_verbosegiveitem_SUPER_ROD
  FishingGuruScript_0x69b55.ckir_BEFORE_verbosegiveitem_OLD_ROD
  SageLiScript.ckir_BEFORE_verbosegiveitem_HM_FLASH
  UnknownScript_0x6d184.ckir_BEFORE_verbosegiveitem_HM_WHIRLPOOL
  GentlemanScript_0x7d9bf.ckir_BEFORE_verbosegiveitem_CARD_KEY
  WarehouseEntranceCoinCase.ckir_BEFORE_itemball_COIN_CASE

  RocketlessLoRLanceScript2.ckir_BEFORE_verbosegiveitem_BASEMENT_KEY
  RocketlessLoRLanceScript2.ckir_BEFORE_verbosegiveitem_CARD_KEY
  RocketlessLoRLanceScript2.ckir_BEFORE_verbosegiveitem_CLEAR_BELL
  RocketlessLoRLanceScript2.ckir_BEFORE_verbosegiveitem_HM_WHIRLPOOL

  UndergroundWarehouseUltraBall.ckir_BEFORE_ITEMBALL_ULTRABALL

  WhitneyScript_0x5400c.ckir_BEFORE_checkflag_ENGINE_PLAINBADGE
  BlackthornGymClairScript.ckir_BEFORE_checkflag_ENGINE_RISINGBADGE

  UnknownText_0x18b064.ckir_BEFORE_para_lost_your_favorite_doll
  Copycat.ckir_BEFORE_takeitem_LOST_ITEM
  Copycat.ckir_BEFORE_checkitem_LOST_ITEM

  FuchsiaGym_MapEventHeader.ckir_BEFORE_person_event_SPRITE_FUCHSIA_GYM_1_at_7_5
  FuchsiaGym_MapEventHeader.ckir_BEFORE_person_event_SPRITE_FUCHSIA_GYM_2_at_11_5
  FuchsiaGym_MapEventHeader.ckir_BEFORE_person_event_SPRITE_FUCHSIA_GYM_3_at_4_9
  FuchsiaGym_MapEventHeader.ckir_BEFORE_person_event_SPRITE_FUCHSIA_GYM_4_at_2_4
  FuchsiaGym_MapEventHeader.ckir_BEFORE_person_event_SPRITE_JANINE_at_10_1

  ckir_BEFORE_giveitem_text_MrPokemonsHouse_GotEggText
  ckir_BEFORE_giveitem_text_ReceivedSecretpotionText
  ckir_BEFORE_giveitem_text_UnknownText_0x191d0a
  ckir_BEFORE_giveitem_text_UnknownText_0x54848
  ckir_BEFORE_giveitem_text_UnknownText_0x703df

  ClairText_Lazy.ckir_BEFORE_text_RISINGBADGE
  LeaderBlueWinText.ckir_BEFORE_text_EARTHBADGE
  UnknownText_0x18870c.ckir_BEFORE_text_CASCADEBADGE
  UnknownText_0x189df4.ckir_BEFORE_text_MARSHBADGE
  UnknownText_0x192238.ckir_BEFORE_text_THUNDERBADGE
  UnknownText_0x195fa1.ckir_BEFORE_text_SOULBADGE
  UnknownText_0x1ab646.ckir_BEFORE_text_VOLCANOBADGE
  UnknownText_0x54222.ckir_BEFORE_text_PLAINBADGE
  UnknownText_0x6854a.ckir_BEFORE_text_ZEPHYRBADGE
  UnknownText_0x72c3e.ckir_BEFORE_text_RAINBOWBADGE
  UnknownText_0x9d7f6.ckir_BEFORE_text_STORMBADGE

  UnknownText_0x685c8.ckir_BEFORE_text_ZEPHYRBADGE_unimportant
  BugsyText_HiveBadgeSpeech.ckir_BEFORE_text_HIVEBADGE_unimportant
  UnknownText_0x5428b.ckir_BEFORE_text_PLAINBADGE_unimportant
  UnknownText_0x9a059.ckir_BEFORE_text_FOGBADGE_unimportant
  UnknownText_0x9d84d.ckir_BEFORE_text_STORMBADGE_unimportant
  UnknownText_0x9c354.ckir_BEFORE_text_MINERALBADGE_unimportant
  UnknownText_0x199d55.ckir_BEFORE_text_GLACIERBADGE_unimportant
  BlackthornGymClairText_DescribeBadge.ckir_BEFORE_text_RISINGBADGE_unimportant
  UnknownText_0x1a2a57.ckir_BEFORE_text_BOULDERBADGE_unimportant
  UnknownText_0x192291.ckir_BEFORE_text_THUNDERBADGE_unimportant
  UnknownText_0x189ead.ckir_BEFORE_text_MARSHBADGE_unimportant

  UnknownText_0x685af.ckir_BEFORE_text_ZEPHYRBADGE_received
  Text_ReceivedHiveBadge.ckir_BEFORE_text_HIVEBADGE_received
  UnknownText_0x54273.ckir_BEFORE_text_PLAINBADGE_received
  UnknownText_0x9a043.ckir_BEFORE_text_FOGBADGE_received
  UnknownText_0x9d835.ckir_BEFORE_text_STORMBADGE_received
  UnknownText_0x9c33a.ckir_BEFORE_text_MINERALBADGE_received
  UnknownText_0x199d3b.ckir_BEFORE_text_GLACIERBADGE_received
  ClairText_Lazy.ckir_BEFORE_text_RISINGBADGE_received
  UnknownText_0x1a2a3d.ckir_BEFORE_text_BOULDERBADGE_received
  UnknownText_0x188768.ckir_BEFORE_text_CASCADEBADGE_received
  UnknownText_0x192277.ckir_BEFORE_text_THUNDERBADGE_received
  UnknownText_0x72c96.ckir_BEFORE_text_RAINBOWBADGE_received
  UnknownText_0x195feb.ckir_BEFORE_text_SOULBADGE_received
  UnknownText_0x189e95.ckir_BEFORE_text_MARSHBADGE_received
  UnknownText_0x1ab683.ckir_BEFORE_text_VOLCANOBADGE_received
  Text_ReceivedEarthBadge.ckir_BEFORE_text_EARTHBADGE_received

  AzaleaGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  BlackthornGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  CeladonGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  CeruleanGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  CianwoodGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  EcruteakGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  FuchsiaGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  GoldenrodGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  MahoganyGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  OlivineGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  PewterGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  SaffronGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  SeafoamGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  VermilionGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  VioletGymTriggerRockets.ckir_BEFORE_GoldenrodRockets
  ViridianGymTriggerRockets.ckir_BEFORE_GoldenrodRockets

  AzaleaGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  BlackthornGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  CeladonGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  CeruleanGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  CianwoodGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  EcruteakGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  FuchsiaGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  GoldenrodGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  MahoganyGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  OlivineGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  PewterGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  SaffronGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  SeafoamGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  VermilionGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  VioletGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
  ViridianGymTriggerRockets.ckir_BEFORE_RadioTowerRockets
)

ORIG_JSON = ENV.fetch("ORIG_JSON", "#{VERSION}-speedchoice-labels-label-details.json")
MOD_JSON = ENV.fetch("MOD_JSON", "#{VERSION}-speedchoice-changes-label-details.json")

def speedchoice_labels_json
   JSON.load(File.read(ORIG_JSON)).
    sort_by { |h| h['label'] }
end

def speedchoice_changes_json
  JSON.load(File.read(MOD_JSON)).
    sort_by { |h| h['label'] }
end

def diff
  speedchoice_labels_json.
    zip(speedchoice_changes_json).
    filter { |orig, modified| orig != modified }.
    map do |orig, modified|
      raise <<~EOF unless orig['label'] == modified['label'] && orig['address_range'] == modified['address_range']
        #{orig['label']} != #{modified['label']}
        #{orig['address_range']} != #{modified['address_range']}
      EOF

      {
        :label => orig['label'],
        :address_range => orig['address_range'],
        :integer_values => {
          :old => orig['integer_values'].split(" ").map(&method(:Integer)),
          :new => modified['integer_values'].split(" ").map(&method(:Integer)),
        },
      }
    end.
    reject { |d| BLACKLISTED_LABELS.include?(d['label']) }.
    to_json
end

def patches
  speedchoice_labels_json.
    filter { |p| PATCHES.include?(p['label']) }.
    map do |p|
      {
        :label => p['label'],
        :address_range => p['address_range'],
        :integer_values => {
          :old => p['integer_values'].split(" ").map(&method(:Integer)),
        },
      }
    end.
    to_json
end

def main
  File.write("#{VERSION}-speedchoice-changes-diff.json", diff)
  File.write("#{VERSION}-patches.json", patches)
end

main
